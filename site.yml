---
# Basic demo of using Ansible to create a virtual machine on Pouta.csc.fi
#
# You'll need to download and source your credentials before this will work:
#  https://research.csc.fi/pouta-credentials
#
- name: Pouta ansible demo
  # The OpenStack modules only work with your local machine.
  hosts: localhost
  # And it doesn't use local facts
  gather_facts: false

  vars:
    pouta_username: "{{ lookup('env','OS_USERNAME') }}"
    pouta_password: "{{ lookup('env','OS_PASSWORD') }}"
    tenant_name: "{{ lookup('env','OS_TENANT_NAME') }}"
    auth_url: "{{ lookup('env','OS_AUTH_URL') }}"

    pouta_tiny: 1a0f1143-47b5-4e8a-abda-eba52ae3c5b9
    pouta_centos7: e191e959-2357-41ed-8c11-09438f5b148e

    # These will need changing.
    demo_key: jenkins
    demo_security_groups: default,CSCNets-core
    demo_network: 16ed69b0-9886-473c-a1c0-a25d80b82d5a

  tasks:
    - name: Create a virtual machine
      register: result
      os_server:
        state: present
        name: pouta-demo
        auth:
          auth_url: "{{ auth_url }}"
          username: "{{ pouta_username }}"
          password: "{{ pouta_password }}"
          project_name: "{{ tenant_name }}"
        image: "{{ pouta_centos7 }}"
        key_name: "{{ demo_key }}"
        flavor: "{{ pouta_tiny }}"
        security_groups: "{{ demo_security_groups }}"
        nics:
          - net-id: "{{ demo_network }}"
    - name: Wait for instance to be ready
      wait_for: host={{ result.server.networks.values()[0][1] }} port=22
    - name: Add new host to inventory
      add_host: name={{ result.server.networks.values()[0][1] }} groups=new
- name: Configure demo host
  hosts: new
  remote_user: cloud-user
  sudo: yes

  vars:
    demo_photo: kajaani.jpg
    demo_greeting: "Hello from Kajaani!"

  tasks:
   - name: Install a webserver
     yum: name=httpd state=present

   - name: Deploy demo web page
     template: src=templates/demo.html.j2 dest=/var/www/html/index.html owner=apache group=apache mode=0644

   - name: Copy a picture of Kajaani
     copy: src=resources/kajaani.jpg dest=/var/www/html/kajaani.jpg owner=apache group=apache mode=0644

   - name: Configure firewall
     template: src=templates/iptables.j2 dest=/etc/sysconfig/iptables owner=root group=root mode=0600
     notify:
       - reload iptables

   - name: Start apache
     service: name=httpd state=started enabled=yes

  handlers:
    - name: reload iptables
      service: name=iptables state=reloaded
